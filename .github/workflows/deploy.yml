name: ğŸ” Secure VPS CI/CD Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y lftp sshpass

      - name: ğŸ“¤ Upload via SFTP using lftp
        run: |
          chmod +x .github/scripts/upload.sh
          bash .github/scripts/upload.sh
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USER }}
          PASSWORD: ${{ secrets.VPS_PASSWORD }}

      - name: ğŸš€ Remote deployment via SSH
        env:
          SSH_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          SSH_USER: ${{ secrets.VPS_USER }}
          SSH_HOST: ${{ secrets.VPS_HOST }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
            # Permissions
            chown -R www-data:www-data /var/www/emailing
            chmod -R 775 /var/www/emailing/storage /var/www/emailing/bootstrap/cache  

            cd /var/www/emailing

            # Clear caches
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan migrate --force

            # Copy environment file
            mv /var/www/emailing/.env.prod /var/www/emailing/.env
            
            # RedÃ©marrage des queues
            php artisan queue:restart
          EOF
