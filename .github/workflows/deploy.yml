name: ğŸ” Secure VPS CI/CD Deploy

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y lftp openssh-client

      - name: ğŸ“¤ Upload via SFTP using lftp
        run: |
          chmod +x .github/scripts/upload.sh
          bash .github/scripts/upload.sh
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USER }}
          PASSWORD: ${{ secrets.VPS_PASSWORD }}

      - name: ğŸš€ Remote deployment via SSH
        run: |
          echo "ğŸ“¤ Upload du script de dÃ©ploiement..."
          scp -i ~/.ssh/id_ed25519 -P ${{ secrets.HOST_PORT }} .github/scripts/deploy.sh ${{ secrets.HOST_USER }}@${{ secrets.HOST_IP }}:/tmp/deploy.sh

          echo "ğŸŸ¢ Connexion SSH et exÃ©cution du script distant..."
          ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.HOST_PORT }} ${{ secrets.HOST_USER }}@${{ secrets.HOST_IP }} <<'EOF'
            set -euo pipefail

            echo "ğŸ” Injection des variables d'environnement..."
            export HOST="${{ secrets.VPS_HOST }}"
            export USER="${{ secrets.VPS_USER }}"
            export PASSWORD="${{ secrets.VPS_PASSWORD }}"

            echo "ğŸš€ ExÃ©cution du script de dÃ©ploiement..."
            bash /tmp/deploy.sh

            echo "ğŸ§¹ Suppression du script temporaire..."
            rm -f /tmp/deploy.sh

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s."
          EOF
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USER }}
          PASSWORD: ${{ secrets.VPS_PASSWORD }}
